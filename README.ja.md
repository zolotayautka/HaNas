# HaNas

[한국어](./README.ko.md) | **日本語** | [English](./README.md)

Webとネイティブモバイルクライアントを備えた軽量で安全なファイル管理システムです。すべてのデバイスでファイルをアップロード、整理、共有、メディアをストリーミングできます。

## 🌟 主な機能

### コア機能
- 📁 **ファイル管理**: フォルダ作成、ファイルアップロード、コピー、移動、名前変更、削除
- 🔐 **ユーザー認証**: JWTベースの安全な認証とユーザー登録
- 🎵 **メディア再生**: 一般的な形式のオーディオおよびビデオプレーヤーを内蔵
- 🖼️ **サムネイル生成**: 画像と動画の自動サムネイル生成
- 🔗 **ファイル共有**: ユニークな共有リンクでファイルとフォルダを共有
- 📊 **アップロード進捗**: マルチパートサポート付きリアルタイムアップロード進捗追跡
- 🔄 **ファイル上書き**: 再アップロード時に既存ファイルを自動更新
- 🌍 **多言語対応**: 日本語、韓国語、英語をサポート

### プラットフォームサポート
- 🌐 **Webインターフェース**: ドラッグ&ドロップサポート付きレスポンシブWeb UI
- 📱 **iOSネイティブクライアント**: iPhoneとiPad用のフル機能SwiftUIアプリ
- 💻 **macOSネイティブクライアント**: ネイティブMacアプリケーション
- 📦 **単一バイナリサーバー**: すべてのアセットが組み込まれ、外部依存関係なし

## サポートされているメディア形式

**オーディオ**: MP3, M4A, WAV, OGG, FLAC, AAC  
**ビデオ**: MP4, WebM, OGG, MOV, MKV  
**画像**: JPG, PNG, GIF, WebP（サムネイルサポート付き）

## 🚀 インストール

### サーバーセットアップ

#### 前提条件
- Go 1.16以上

#### ソースからビルド

```bash
git clone https://github.com/zolotayautka/HaNas.git
cd HaNas/server
go build -o hanas
```

#### 使用方法

1. サーバーを起動:
```bash
./hanas
```

2. ブラウザを開いて以下にアクセス:
```
http://localhost:8080
```

3. 新しいアカウントを登録してファイル管理を開始しましょう！

### iOSクライアントセットアップ

#### 前提条件
- iOS 15.0以上
- Xcode 14.0以上
- Swift 5.7以上

#### インストール

1. Xcodeで `client/hanas for ios/Hanas for ios.xcodeproj` を開く
2. 署名設定で開発チームを選択
3. デバイスまたはシミュレーターでビルドして実行

#### 使用方法

1. アプリを起動
2. HaNasサーバーのURLを入力（例：`http://192.168.1.100`）
3. 認証情報でログインするか、新しいアカウントを登録
4. ネイティブiOSインターフェースでファイルを閲覧・管理

### macOSクライアントセットアップ

1. Xcodeで `client/HaNas for Mac/HaNas for Mac.xcodeproj` を開く
2. ネイティブMacアプリケーションをビルドして実行

## ⚙️ 設定

### サーバー設定
- **ポート**: デフォルトは `8080`（`main()` 関数で変更）
- **データディレクトリ**: `./data`（ファイル保存場所）
- **サムネイルディレクトリ**: `./thumbnails`（サムネイルキャッシュ）
- **データベース**: `./database.db`（SQLiteデータベース）
- **JWT秘密鍵**: 本番環境で設定（セキュリティセクション参照）

### iOSクライアント設定
- **サーバーURL**: 初回ログイン時に設定
- **認証情報**: SQLiteを使用してアプリのDocumentsディレクトリに安全に保存
- **自動ログイン**: アプリ起動時に自動認証

## 📡 APIエンドポイント

詳細なAPIドキュメントは [API_README.md](./API_README.md) を参照してください

### 認証
- `POST /register` - 新しいユーザーアカウントを作成
- `POST /login` - ログインしてJWTトークンを受信
- `POST /logout` - ログアウトしてトークンをクリア
- `GET /me` - 現在のユーザー情報を取得

### ファイル操作
- `GET /node/:id` - ノード情報と子要素を取得
- `GET /file/:id` - ファイルをダウンロードまたはストリーミング
- `GET /thumbnail/:id` - 画像/動画のサムネイルを取得
- `POST /upload` - ファイルアップロードまたはフォルダ作成（マルチパートサポート）
- `POST /copy` - ファイル/フォルダをコピー
- `POST /move` - ファイル/フォルダを移動
- `POST /rename` - ファイル/フォルダの名前変更
- `POST /delete` - ファイル/フォルダを削除

### 共有
- `POST /share/create` - ノードの共有リンクを作成
- `POST /share/delete` - 共有リンクを削除
- `GET /s/:token` - 共有ノードにアクセス（認証不要）
- `GET /share/:token/download` - 共有ファイルをダウンロード

### 進捗追跡
- `GET /progress/:upload_id` - アップロード進捗を取得（0-100）

## 📂 プロジェクト構造

```
HaNas/
├── server/              # バックエンドサーバー
│   ├── app.go          # すべてのAPIエンドポイントを含むメインサーバーロジック
│   ├── go.mod          # Goモジュール依存関係
│   ├── index.html      # Webインターフェース
│   ├── index.js        # フロントエンドロジック
│   └── i18n.js         # 国際化
├── client/             # ネイティブクライアントアプリケーション
│   ├── hanas for ios/  # iOSネイティブクライアント
│   │   └── hanas for ios/
│   │       ├── HaNas_iOSApp.swift      # アプリエントリーポイント
│   │       ├── AppState.swift          # グローバルアプリ状態
│   │       ├── ConfigManager.swift     # 設定ストレージ
│   │       ├── ContentView.swift       # メインビュー
│   │       ├── LoginView.swift         # 認証UI
│   │       ├── FileListView.swift      # ファイルブラウザ
│   │       └── exec.swift              # APIクライアント
│   └── HaNas for Mac/  # macOSネイティブクライアント
├── bin/                # コンパイル済みバイナリとビルド
├── data/               # ユーザーファイルストレージ（自動作成）
├── thumbnails/         # サムネイルキャッシュ（自動作成）
└── database.db         # SQLiteデータベース（自動作成）
```

## 🔧 技術詳細

### バックエンド（サーバー）
- **言語**: Go
- **データベース**: GORMを使用したSQLite
- **認証**: HTTP-onlyクッキーを使用したJWT（24時間有効期限）
- **主な機能**: 
  - ユーザー認証と登録
  - Rangeリクエストサポート付きファイルストリーミング
  - リアルタイムアップロード進捗追跡
  - 画像と動画の自動サムネイル生成
  - トークンベースアクセスで共有可能なリンク
  - MIMEタイプ検出
  - カスケード削除付き階層的フォルダ構造
  - ミューテックスロックによる同時アップロード処理
  - Base64およびマルチパートファイルアップロードサポート

### Webフロントエンド
- **技術**: バニラJavaScript（フレームワークなし）
- **機能**:
  - ドラッグ&ドロップファイルアップロード
  - SSEを使用したリアルタイムアップロード進捗
  - 統合メディアプレーヤー
  - 画像サムネイルプレビュー
  - ファイル共有UI
  - レスポンシブグリッドレイアウト
  - ブラウザ言語検出

### iOSクライアント
- **言語**: Swift 5.7+
- **フレームワーク**: SwiftUI
- **ターゲット**: iOS 15.0+
- **アーキテクチャ**: Combineを使用したMVVM
- **主な機能**:
  - ネイティブiOSファイルピッカー統合
  - フォトライブラリアクセス
  - すべてのファイルタイプ用のドキュメントピッカー
  - PDFプレビューサポート
  - AVKitを使用したビデオ/オーディオプレーヤー
  - グリッドベースのファイルブラウジング
  - コンテキストメニューアクション（コピー、カット、ペースト、削除、名前変更）
  - セキュアストレージによる永続的な認証
  - 多言語サポート（en、ja、ko）
  - サムネイルキャッシング

### macOSクライアント
- **言語**: Swift
- **フレームワーク**: SwiftUI
- **ターゲット**: macOS 12.0+
- **機能**: Mac最適化UIを使用したiOSクライアントと同様
  - ドラッグアンドドロップサポート（ファイル入力経由）
  - リアルタイムアップロード進捗
  - メディアプレーヤー統合
  - レスポンシブデザイン

## 🌍 言語サポート

インターフェースは自動的にブラウザ/デバイスの言語を検出し、以下の言語で表示されます:
- 🇯🇵 **日本語** (ja)
- 🇰🇷 **韓国語** (ko)
- 🇬🇧 **英語** (en)

### サポートされているプラットフォーム
- Webインターフェース（ブラウザ言語検出）
- iOSアプリ（デバイス言語設定）
- macOSアプリ（システム言語設定）

## 🔐 セキュリティ機能

- **パスワードハッシング**: コストファクター14のbcrypt
- **JWT認証**: 24時間有効期限のHTTP-onlyクッキー
- **セキュアトークンストレージ**: プラットフォーム固有のセキュアストレージ（iOS/Mac）
- **ファイルアクセス制御**: ユーザーベースのファイル分離
- **共有トークン**: UUIDベースの共有可能なリンク
- **API認可**: すべての保護されたエンドポイントでミドルウェアベースの認証

## 🛡️ 本番環境のセキュリティに関する考慮事項

⚠️ **これは個人/開発用に設計されています**。本番環境でのデプロイには:

### 必須のセキュリティ更新
1. **JWT秘密鍵の変更**: `app.go`の`jwtSecret`を強力でランダムな値に更新
2. **HTTPSの有効化**: TLS/SSL証明書サポートを追加
3. **レート制限の追加**: 認証に対するブルートフォース攻撃を防止
4. **ファイルアップロード制限**: 最大ファイルサイズと同時アップロード数を設定
5. **入力のサニタイズ**: ファイル名とパスの検証を強化
6. **CORS設定**: クロスオリジンリクエストを制限
7. **環境変数**: シークレットを環境設定に移動
8. **データベースセキュリティ**: 適切なデータベース認証情報と暗号化を使用
9. **監査ログ**: セキュリティイベント用の包括的なロギングを実装
10. **依存関係の更新**: Goモジュールの定期的なセキュリティ更新

### ネットワークセキュリティ
- リバースプロキシの背後にデプロイ（nginx、Apache）
- ファイアウォールルールを使用してアクセスを制限
- リモートアクセス用のVPNを検討
- HTTPS専用接続を有効化

## 🛠️ 開発

### 新しい言語の追加

#### サーバー（Webインターフェース）

1. `server/i18n.js`を編集して言語コードを追加:
```javascript
const i18n = {
  // ... 既存の言語
  fr: {
    home: 'Accueil',
    upload: 'Télécharger',
    // ... すべての翻訳を追加
  }
};
```

2. `server/index.js`の言語検出を更新:
```javascript
if(userLang.startsWith('ja')) lang = 'ja';
else if(userLang.startsWith('ko')) lang = 'ko';
else if(userLang.startsWith('fr')) lang = 'fr'; // これを追加
else lang = 'en';
```

#### iOS/Macクライアント

1. Xcodeで新しい`.lproj`フォルダを追加（例：`fr.lproj/`）
2. 翻訳を含む`Localizable.strings`ファイルを作成:
```
"app_name" = "HaNas";
"login_title" = "Connexion";
// ... すべてのキーを追加
```

### サポートされているメディア形式の変更

`server/index.js`の`isMediaByName()`関数を編集:
```javascript
const audio = ['mp3','m4a','wav','ogg','flac','aac','your-format'];
const video = ['mp4','webm','ogg','mov','mkv','your-format'];
```

## 🐛 トラブルシューティング

### サーバーの問題

**問題**: フォルダと同じ名前のファイルをアップロードできない  
**解決策**: これは競合を防ぐための設計です。まずファイルまたはフォルダの名前を変更してください。

**問題**: メディアファイルが再生されない  
**解決策**: ファイル形式がサポートされているか確認してください。コンテナ形式がリストされていても、ブラウザがすべてのコーデックをサポートしているとは限りません。

**問題**: アップロード進捗が0%で止まる  
**解決策**: ブラウザのコンソールでエラーを確認してください。upload_idパラメータが正しく生成されているか確認してください。

### iOS/Macクライアントの問題

**問題**: サーバーに接続できない  
**解決策**: 
- サーバーURLが正しいか確認（http://またはhttps://を含む）
- デバイスがサーバーと同じネットワークにあることを確認
- サーバーのファイアウォール設定を確認
- まずSafariでサーバーURLにアクセスしてみる

**問題**: 認証情報は正しいのにログイン失敗  
**解決策**: 
- アプリデータをクリアして再試行
- 認証エラーのサーバーログを確認
- JWTトークンがクッキーに設定されているか確認

## 📄 ライセンス

MIT License

## 🤝 コントリビューション

コントリビューションを歓迎します！プルリクエストをお気軽に提出してください。

## 🙏 謝辞

- GORM - データベースORM
- JWT - 認証
- FFmpeg - 動画サムネイル
- nfnt/resize - 画像処理

---

Go、Swift、バニラJavaScriptで❤️を込めて制作

**すべての人のためのマルチプラットフォームファイル管理**
